<style>
  .finder {
    width: 100%;
    height: 100%;
    background: #fff;
  }

  .finder-toolbar {
    width: 100%;
    height: 40px;
    padding: 8px;
    background: #f5f5f5;
    border-bottom: 1px solid #ddd;
  }

  .finder-path {
    width: calc(100% - 90px);
    height: 24px;
    padding: 6px;
    margin-right: 10px;
    font-size: 12px;
    line-height: 12px;
    background: #fff;
    border: 1px solid #bbb;
  }

  .finder-btn {
    width: 24px;
    height: 24px;
    margin-right: 10px;
    background: #ddd;
    border-radius: 50%;
    cursor: pointer;
    color: #777;
  }
  .finder-btn:hover {
    background: #eee;
  }

  .finder-main {
    width: 100%;
    height: calc(100% - 40px);
    padding: 20px;
    overflow: auto;
  }

  .folder,
  .file {
    width: 100px;
    height: 130px;
    display: inline-block;
    margin: 0 30px 30px 0;
  }

  .finder-name {
    text-align: center;
    color: #333;
  }
  .finder-name-editing {
    border: 1px dotted #aaa;
  }
  .finder-name-editing div,
  .finder-name-editing br {
    display: none;
  }

  .finder-icon {
    width: 100px;
    height: 100px;
  }
  .file .finder-icon {
    width: 80px;
    margin-left: 10px;
  }

</style>

<div class="finder">
  <div class="finder-toolbar">
    <button class="finder-btn finder-back-btn">b</button><!-- 
    <button class="finder-btn finder-forward-btn">f</button> -->
    <input type="text" class="finder-path" value="/">
    <button class="finder-btn finder-go-btn">g</button>
  </div>
  <div class="finder-main"></div>
</div>

<script>
  (function () {

    var fs = require('fs');
    var iconv = require('iconv-lite');

    var isEditing = false;
    var history = '';

    initFinder();

    var timer = setInterval(function () {
      if ($('.finder')) {
        if (!isEditing) {
          listFinder();
        }
      } else {
        clearInterval(timer);
      }
    }, 1000);

    function initFinder() {
      performLs('/');
      $$.bind($('.finder'), 'click', endRenaming);
      $$.bind($('.finder-path'), 'keyup', gotoPath);
      $$.bind($('.finder-go-btn'), 'click', gotoPath);
      $$.bind($('.finder-back-btn'), 'click', goBack);
    }

    function listFinder () {
      fs.readFile('out.txt', function (err, data) {
        if (!err) {
          var output = iconv.decode(data, 'gbk');
          var list = output.match(/\[LIST\]([\s\S]*)\[LIST_END\]/);
          if (list) {
            loadFinderList(list.pop());
          }
        }
      });
    }

    function loadFinderList (list) {
      var html = '';
      if (list != '\r\n') {
        var files = list.split('\n');
        for (var i = 1; i < files.length - 1; i++) {
          var file = files[i].split(' ');
          if (file[3] == '0') {
            html += '<div class="folder"><p><img src="../assets/img/folder.png" class="finder-icon" alt=""></p><p class="finder-name">' + file[0] + '</p></div>';
          } else if (file[3] == '1') {
            html += '<div class="file"><p><img src="../assets/img/file.png" class="finder-icon" alt=""></p><p class="finder-name">' + file[0] + '</p></div>';
          }
        }
      }
      if (history != html) {
        history = html;
        $('.finder-main').innerHTML = html;
        if ($('.finder-name')) {
          $$.bind($('.finder-name'), 'dblclick', startRenaming);
        }
        if ($('.folder .finder-icon')) {
          $$.bind($('.folder .finder-icon'), 'dblclick', gotoFolder);
        }
      }
    }

    function startRenaming (e) {
      endRenaming();
      isEditing = true;
      var p = e.target;
      var oldName = p.innerHTML;
      p.addClass('finder-name-editing');
      p.setAttribute('contenteditable', true);
      $$.bind(p, 'keyup', function (e) {
        if (e.keyCode == 13) {
          endRenaming();
          p.innerHTML = p.innerHTML.replace(/<div><br><\/div>/g, '');
          var path = $('.finder-path').value;
          path = (path == '/') ? '' : path + '/';
          fs.writeFile('in.txt', 'rn ' + path + oldName + ' ' + p.innerHTML);
        }
      });
    }

    function endRenaming (e) {
      if (isEditing) {
        $$.unbind($('.finder-name-editing'), 'keyup');
        $('.finder-name-editing').removeAttribute('contenteditable');
        $('.finder-name-editing').removeClass('finder-name-editing');
        isEditing = false;
      }
    }

    function gotoFolder (e) {
      var folderName = e.target.parentNode.parentNode.find('.finder-name').innerHTML;
      if ($('.finder-path').value.substr(-1) != '/') {
        $('.finder-path').value += '/';
      }
      $('.finder-path').value += folderName;
      $('.finder-go-btn').click();
    }

    function gotoPath (e) {
      if (e instanceof MouseEvent || (e.keyCode && e.keyCode == 13)) {
        performLs($('.finder-path').value);
        fs.readFile('out.txt', function (err, data) {
          if (!err) {
            var output = iconv.decode(data, 'gbk');
            var exception = output.match(/\[EXCEPTION\]([\s\S]*)\[EXCEPTION_END\]/);
            if (exception) {
              alert('cannot find path \'' + $('.finder-path').value + '\'');
            } else {
              listFinder();
            }
          }
        });
      }
    }

    function goBack () {
      var tmpPath = $('.finder-path').value.substring(0, $('.finder-path').value.lastIndexOf('/'));
      if (tmpPath == '') {
        tmpPath = '/';
      }
      $('.finder-path').value = tmpPath;
      $('.finder-go-btn').click();
    }

    function performLs(path) {
      fs.writeFile('in.txt', 'ls ' + path, function (err) {
        if (err) {
          console.log(err);
        }
      });
    }

  })();
</script>